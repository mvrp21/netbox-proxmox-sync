{% block content %}

<div id="result-container" class="mt-4">
    <div id="loading-spinner" class="text-center"></div>
    <div id="changelog"></div>
</div>

<script>
    const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    const spinner = document.getElementById("loading-spinner");
    const changelog = document.getElementById("changelog");

    document.addEventListener("DOMContentLoaded", function() {
        const button = document.getElementById("sync-proxmox-cluster");
        button.addEventListener("click", syncCluster);
    });

    function syncCluster() {
        const START = new Date();
        spinner.innerHTML = '<div class="spinner-grow justify-content-center" style="height: 10rem; width: 10rem;" role="status"></div>';
        const connection_id = {{ object.id }};
        fetch(`/api/plugins/nbp-sync/sync/${connection_id}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
        })
        .then((response) => response.json())
        .then((data) => {
            console.log(data);
            const END = new Date();
            const ISO_START = START.toISOString();
            const ISO_END = END.toISOString();
            const URL = window.location.origin;
            const CHANGELOG_URL = `/core/changelog/?time_before=${ISO_END}&time_after=${ISO_START}&changed_object_type_id=90&changed_object_type_id=123&changed_object_type_id=124`;
            renderMessages( CHANGELOG_URL );
            return fetch(CHANGELOG_URL, { headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json",
            }});
        })
        .then((response) => response.text())
        .then((changelog) => {
            spinner.innerHTML = "";
            renderChangelog(changelog);
        })
        .catch((error) => {
            console.error("Error:", error);
            spinner.innerHTML = "";
        });
    }

    function renderMessages(returnedData) {
        spinner.innerText = returnedData;
    }

    function renderChangelog(changelogPageText) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(changelogPageText, "text/html");
        const table = doc.getElementsByClassName("card")[0];
        if (table) {
            changelog.appendChild(table);
        }
    }

</script>

{% endblock content %}
